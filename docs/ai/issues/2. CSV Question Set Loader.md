# Issue #2: CSV Clue Set Loader

**Status**: ‚úÖ **COMPLETE** - Full drag-and-drop upload functionality implemented
**Priority**: ‚úÖ Foundation Complete
**Epic**: Content Management
**Completed**: 2025-01-15
**Total Time**: 12 hours

## Completion Summary

**üéâ FULLY IMPLEMENTED:**
- ‚úÖ **CSV Parser**: Complete with comprehensive validation (388 lines)
- ‚úÖ **Database Integration**: Full clue set saving with relationships (612 lines)
- ‚úÖ **Daily Double Algorithm**: Implemented with authentic probability distribution
- ‚úÖ **Database-driven clue set selection**: ClueSetSelector queries user's clue sets from database
- ‚úÖ **Drag-and-drop file upload**: Full-viewport drag-and-drop interface with visual feedback
- ‚úÖ **Clue set management UI**: Complete upload, naming, and user's clue set list
- ‚úÖ **Upload workflow integration**: Seamless CSV pipeline from file drop to database
- ‚úÖ **Delete clue set functionality**: Professional confirmation dialog with proper cleanup
- ‚úÖ **Duplicate name checking**: Overwrite/cancel options with user prompts
- ‚úÖ **Clue set summary panel**: Shows categories for all rounds with creation dates
- ‚úÖ **Professional UX**: Automatic selection, visual feedback, no intrusive dialogs
- ‚úÖ **Code Quality**: All SonarQube and ESLint issues resolved

## Overview

Complete the production upload workflow for CSV clue sets. The core parsing and database functionality is complete - we need to replace the temporary file-based system with a proper database-driven upload interface where users can drag-and-drop CSV files directly onto the game creation screen.

## Goals

- **Primary**: Replace file system with database-driven clue set selection
- **Secondary**: Implement seamless drag-and-drop upload interface
- **Tertiary**: Enable users to manage their own clue set collections
- **Quaternary**: Add clue set management features (delete, duplicate handling, preview)

## Production Upload Implementation Plan

### Phase 1: Database-Driven Clue Set Selection (1-2 hours)

**1.1 Create Clue Set Database Service**
```typescript
// src/services/clueSets/clueSetService.ts
interface UserClueSet {
  id: string
  name: string
  created_at: string
  created_by: string
}

// getUserClueSets(userId: string): Promise<UserClueSet[]>
// deleteClueSet(clueSetId: string, userId: string): Promise<void>
// renameClueSet(clueSetId: string, newName: string, userId: string): Promise<void>
```

**1.2 Update ClueSetSelector Component**
```typescript
// src/components/clueSets/ClueSetSelector.tsx
// Replace getAvailableClueSets() hardcoded list with database query
// Show user's uploaded clue sets from database
// Add loading states and error handling
// Maintain existing dropdown interface
```

### Phase 2: Integrated Drag-and-Drop Upload Interface (2-3 hours)

**2.1 Enhanced Game Creation Screen**
```typescript
// Modify App.tsx game creation area to be a drop zone
// Add drag-and-drop event handlers to .content-section.game-creator-section
// Visual feedback: highlight border and "Drop CSV file here" overlay
// File validation: ensure dropped file is CSV format
```

**2.2 File Upload Processing**
```typescript
// src/services/clueSets/uploadService.ts
interface UploadResult {
  success: boolean
  clueSetId?: string
  clueSetName?: string
  error?: string
}

// processDroppedFile(file: File, userId: string): Promise<UploadResult>
// validateCSVFile(file: File): Promise<boolean>
// promptForClueSetName(filename: string): Promise<string>
```

**2.3 Upload Workflow Integration**
```typescript
// Integrate with existing CSV pipeline:
// 1. User drops CSV file onto game creation screen
// 2. Validate file type and prompt for clue set name
// 3. Parse CSV using existing csvParser.ts
// 4. Save to database using existing saveClueSetToDatabase()
// 5. Refresh ClueSetSelector dropdown with new clue set
// 6. Auto-select newly uploaded clue set
// 7. User can immediately click "Host Game"
```

### Phase 3: Enhanced Clue Set Management UI (2-3 hours)

**3.1 Delete Clue Set Functionality**
```typescript
// Add red "X" button next to dropdown when clue set is selected
// Confirmation dialog: "Are you sure you want to delete [Clue Set Name]?"
// Database deletion with cascade to related records (boards, categories, clues)
// Update dropdown list after successful deletion
// Error handling for deletion failures
```

**3.2 Duplicate Name Checking**
```typescript
// Check for existing clue set names during upload process
// Present options when duplicate detected:
//   - "Overwrite existing clue set"
//   - "Cancel and choose different name"
// Database constraint enforcement for unique names per user
// Clear error messaging for name conflicts
```

**3.3 Clue Set Summary Panel**
```typescript
// Display when clue set is selected from dropdown
// Show categories for all three rounds:
//   - Jeopardy Round: [6 categories]
//   - Double Jeopardy Round: [6 categories]
//   - Final Jeopardy: [1 category]
// Collapsible/expandable design
// Help users identify/recall selected clue set content
```

**3.4 Enhanced Management Features**
```typescript
// Upload progress indicators and status messages
// Comprehensive error handling and user feedback
// Loading states for all database operations
// Responsive design for mobile devices
```

## Updated File Structure

```
src/
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ csvParser.ts              ‚úÖ (388 lines - COMPLETE)
‚îÇ   ‚îî‚îÄ‚îÄ clueSetUtils.ts           ‚úÖ (147 lines - COMPLETE)
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ clueSets/
‚îÇ       ‚îú‚îÄ‚îÄ loader.ts             ‚úÖ (612 lines - COMPLETE)
‚îÇ       ‚îú‚îÄ‚îÄ clueSetService.ts     ‚ùå (NEW - database operations)
‚îÇ       ‚îî‚îÄ‚îÄ uploadService.ts      ‚ùå (NEW - file upload handling)
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îî‚îÄ‚îÄ clueSets/
‚îÇ       ‚îú‚îÄ‚îÄ ClueSetSelector.tsx   üîÑ (109 lines - needs database integration)
‚îÇ       ‚îú‚îÄ‚îÄ ClueSetSummary.tsx    ‚ùå (NEW - category preview panel)
‚îÇ       ‚îî‚îÄ‚îÄ DeleteClueSetButton.tsx ‚ùå (NEW - delete functionality)
‚îî‚îÄ‚îÄ app/
    ‚îî‚îÄ‚îÄ App.tsx                   üîÑ (275 lines - needs drag-and-drop)
```

## Success Criteria

**‚úÖ COMPLETED:**
- [x] CSV data parsing with comprehensive validation
- [x] Clue set saving to database with proper relationships
- [x] Daily Double algorithm with authentic probability distribution
- [x] File name conversion to display names
- [x] Temporary file-based clue set selection working

**‚ùå REMAINING:**
- [ ] Database-driven clue set selection (replace hardcoded file list)
- [ ] Drag-and-drop file upload interface on game creation screen
- [ ] File upload processing and validation
- [ ] Clue set naming during upload process with duplicate checking
- [ ] Delete clue set functionality with red "X" button and confirmation
- [ ] Clue set summary panel showing categories for selected clue set
- [ ] User clue set management (list, delete, rename)
- [ ] Integration of upload workflow with existing CSV pipeline
- [ ] Auto-selection of newly uploaded clue sets

## Detailed Implementation Specifications

### Drag-and-Drop UX Design

**Integrated Drop Zone Approach:**
- The entire game creation screen (`.content-section.game-creator-section`) becomes a drop zone
- Users can either select from dropdown OR drag CSV file onto screen
- When file is dropped, it automatically uploads, processes, and becomes selected clue set
- Seamless workflow with no separate upload steps

**Visual Feedback:**
```typescript
// Drag-and-drop states and visual cues
interface DragState {
  isDragOver: boolean
  isProcessing: boolean
  uploadProgress?: number
}

// Visual feedback during drag operations:
// - Highlighted border when dragging over screen
// - Overlay message: "Drop CSV file here to upload new clue set"
// - Processing spinner during upload and parsing
// - Success message with auto-selection confirmation
```

**File Processing Workflow:**
1. User drags CSV file onto game creation screen
2. Validate file type (must be .csv)
3. Prompt user for clue set name (or auto-generate from filename)
4. Parse CSV using existing `csvParser.ts` with full validation
5. Save to database using existing `saveClueSetToDatabase()`
6. Refresh ClueSetSelector dropdown to include new clue set
7. Auto-select newly uploaded clue set
8. User can immediately click "Host Game"

### Database Integration Changes

**Current Architecture (Temporary):**
```typescript
// src/utils/clueSetUtils.ts - CURRENT
export function getAvailableClueSets(): string[] {
  return ['test-game-1.csv'] // Hardcoded file list
}
```

**Target Architecture (Production):**
```typescript
// src/services/clueSets/clueSetService.ts - NEW
export async function getUserClueSets(userId: string): Promise<UserClueSet[]> {
  // Query clue_sets table for user's uploaded clue sets
  // Return list with id, name, created_at for dropdown population
}
```

### File Upload Processing

**Upload Service Interface:**
```typescript
// src/services/clueSets/uploadService.ts
interface FileUploadOptions {
  file: File
  userId: string
  clueSetName?: string
}

interface UploadResult {
  success: boolean
  clueSetId?: string
  clueSetName?: string
  error?: string
  validationErrors?: string[]
  duplicateDetected?: boolean
}

interface DuplicateHandlingOptions {
  overwriteExisting: boolean
  newName?: string
}

export async function processFileUpload(options: FileUploadOptions): Promise<UploadResult>
export async function checkDuplicateName(name: string, userId: string): Promise<boolean>
export async function handleDuplicateClueSet(options: DuplicateHandlingOptions): Promise<UploadResult>
```

**Delete Service Interface:**
```typescript
// src/services/clueSets/clueSetService.ts
interface DeleteResult {
  success: boolean
  error?: string
}

export async function deleteClueSet(clueSetId: string, userId: string): Promise<DeleteResult>
export async function getClueSetSummary(clueSetId: string): Promise<ClueSetSummary>
```

**Clue Set Summary Interface:**
```typescript
interface ClueSetSummary {
  id: string
  name: string
  rounds: {
    jeopardy: string[]      // 6 category names
    doubleJeopardy: string[] // 6 category names
    finalJeopardy: string    // 1 category name
  }
  createdAt: string
  totalClues: number
}
```

## Technical Architecture Notes

**Existing Components (Working):**
- ‚úÖ `csvParser.ts` - Complete CSV parsing with comprehensive validation
- ‚úÖ `dailyDoubleAlgorithm.ts` - Authentic probability distribution implementation
- ‚úÖ `saveClueSetToDatabase()` - Full database integration with relationships
- ‚úÖ Database schema - All tables and RLS policies working correctly

**Integration Points:**
- üîÑ `ClueSetSelector.tsx` - Needs database query instead of hardcoded list
- üîÑ `App.tsx` - Needs drag-and-drop handlers and upload workflow
- ‚ùå `clueSetService.ts` - New service for database operations and clue set management
- ‚ùå `uploadService.ts` - New service for file upload processing and duplicate checking
- ‚ùå `ClueSetSummary.tsx` - New component for displaying selected clue set categories
- ‚ùå `DeleteClueSetButton.tsx` - New component for delete functionality with confirmation

**Current Workflow (Temporary):**
```
User selects from dropdown ‚Üí handleHostGame() ‚Üí loadClueSetFromCSV() ‚Üí saveClueSetToDatabase() ‚Üí GameService.createGame()
```

**Target Workflow (Production):**
```
User drags file OR selects from dropdown ‚Üí processFileUpload() (if new file) ‚Üí duplicate check ‚Üí clue set summary display ‚Üí handleHostGame() ‚Üí GameService.createGame()
```

**Delete Workflow:**
```
User selects clue set ‚Üí red "X" button appears ‚Üí confirmation dialog ‚Üí deleteClueSet() ‚Üí refresh dropdown
```

## Next Steps After Completion

1. **Replace hardcoded file list** with database-driven clue set selection
2. **Implement drag-and-drop interface** on game creation screen
3. **Add file upload processing** with user naming and validation
4. **Test end-to-end workflow** from file drop to game creation
5. **Resume Issue #3** (Game Host Dashboard) with real clue data loading

## Future Enhancement Phases

### Phase 3 Immediate (After Core Game Works)
- Clue set management UI (delete, rename, duplicate detection)
- Upload progress indicators and better error handling
- Bulk upload and clue set organization features

### Phase 4 Public Release (Much Later)
- Clue set sharing between users
- Import from external sources (J-Archive, etc.)
- Rich text formatting and multimedia clue support
- Clue set templates, wizards, and collaborative editing

## Current Blocker Resolution

**Issue**: Game Host Dashboard (Issue #3) is blocked because it needs real clue data instead of hardcoded placeholders.

**Solution**: Once this production upload system is complete, Issue #3 can resume development with database-driven clue set selection and real game board population.

**Priority**: This is the final piece needed to complete the foundation layer and enable full game development.

---

*This production upload system completes the CSV clue set loader and enables seamless user-generated content workflow for the Jeopardy game platform.*
