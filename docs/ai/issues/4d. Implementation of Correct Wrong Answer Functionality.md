# Issue #4d: Implementation of Correct/Wrong Answer Functionality

**Status**: üî¥ CRITICAL BUG - Incorrect Jeopardy Rules Implementation
**Assignee**: Development Team
**Epic**: Player Experience
**Priority**: üî¥ HIGH (Blocks proper gameplay)
**Estimated Effort**: 1 development session

## üö® **Problem Statement**

The current implementation of "Mark Correct" and "Mark Wrong" functionality violates fundamental Jeopardy rules. When a player is marked wrong, the clue should remain active for other players to attempt, but the current implementation incorrectly completes the clue and moves on.

## üìã **Current Flow Analysis**

### **Current Implementation (INCORRECT)**

#### **1. Clue Selection Phase**
- **Host Action**: Clicks clue cell on game board
- **System Response**:
  - Calls `handleRevealClue(clue)`
  - Sets `focused_clue_id = clue.id` in database
  - Sets `is_buzzer_locked = true`
- **Player Experience**: Modal appears showing clue text, buzzer shows "LOCKED" state
- **Host Interface**: Button changes from "Reveal Prompt" to "Unlock Buzzer"

#### **2. Buzzer Unlock Phase**
- **Host Action**: Clicks "Unlock Buzzer" button
- **System Response**:
  - Calls `handleToggleBuzzer()`
  - Sets `is_buzzer_locked = false` in database
- **Player Experience**: Buzzer becomes active (green, pulsing), players can click to buzz
- **Host Interface**: Button changes from "Unlock Buzzer" to "Lock Buzzer"

#### **3. Player Buzz Phase**
- **Player Action**: Clicks buzzer button
- **System Response**:
  - Calls `GameService.recordBuzz(gameId, clueId, userId, reactionTimeMs)`
  - Records buzz in database with client-calculated reaction time
  - Real-time update sent to host
- **Player Experience**: Buzzer shows "BUZZED" state with reaction time display
- **Host Interface**: Player appears in buzzer queue with name and reaction time

#### **4. Host Selection Phase**
- **Host Action**: Clicks player name in buzzer queue
- **System Response**:
  - Calls `handleSelectPlayer(playerId)`
  - Sets `focused_player_id = playerId` in database
- **Player Experience**: Modal disappears for selected player (‚ùå ISSUE: modal should only disappear when player is marked wrong or clue is marked completed, not when player is selected)
- **Host Interface**: Shows "Mark Correct" and "Mark Wrong" buttons for selected player

#### **5. Adjudication Phase (THE CRITICAL BUG)**

##### **Mark Correct Flow (CORRECT)**
- **Host Action**: Clicks "Mark Correct" button
- **System Response**:
  - Calls `GameService.adjudicateAnswer(gameId, clueId, playerId, true)`
  - Updates player score (+clue value)
  - Sets `focused_clue_id = null` (clue completed) ‚úÖ CORRECT
  - Clue marked completed ‚úÖ CORRECT
  - Sets `focused_player_id = null`
  - Sets `is_buzzer_locked = true`
  - Clears all buzzes for this clue
- **Player Experience**: Modal disappears for all players ‚úÖ CORRECT
- **Host Interface**: Returns to normal board view, clue marked as completed ‚úÖ CORRECT

##### **Mark Wrong Flow (INCORRECT - THE BUG)**
- **Host Action**: Clicks "Mark Wrong" button
- **System Response**:
  - Calls `GameService.adjudicateAnswer(gameId, clueId, playerId, false)`
  - Updates player score (-clue value)
  - Sets `focused_clue_id = null` (clue completed) ‚ùå **WRONG!**
  - Clue marked completed ‚ùå **WRONG!**
  - Sets `focused_player_id = null`
  - Sets `is_buzzer_locked = true` ‚ùå **WRONG!**
  - Clears all buzzes for this clue ‚ùå **WRONG!**
- **Player Experience**: Modal disappears for all players ‚ùå **WRONG!**
- **Host Interface**: Returns to normal board view, clue marked as completed ‚ùå **WRONG!**

## üéØ **Correct Jeopardy Rules**

### **What Should Happen When Player Is Marked Wrong**

According to official Jeopardy rules:
1. **Player's score is updated** (subtract clue value) ‚úÖ Currently correct
2. **Clue remains active** for other players to attempt ‚ùå Currently wrong
3. **Buzzer is unlocked** for remaining players ‚ùå Currently wrong
4. **Buzzer timeout is reset** for remaining players ‚ùå Timeout current unimplemented
5. **Modal disappears only for the wrong player** ‚ùå Currently wrong (modal disappears for all players)
6. **Buzzer queue is cleared** of current attempt ‚úÖ Currently correct
7. **Host can continue** to accept buzzes from other players ‚ùå Currently wrong

### **Clue Completion Conditions**

A clue should only be marked as completed when:
- ‚úÖ **Someone answers correctly** (Mark Correct)
- ‚úÖ **All players have been marked wrong** (no one left to buzz)
- ‚úÖ **Time expires** (handled by game host and set by a constant value, e.g. 5 seconds)

## üîß **Required Changes**

### **Database Schema Changes**
We will need to add an array field to the `clues` table to record players who have been locked out of being able to buzz into the current clue:

```sql
ALTER TABLE clues ADD COLUMN locked_out_player_ids TEXT[] DEFAULT '{}';
```

This field will store user IDs of players who have already been marked wrong for this specific clue and should be prevented from buzzing again.

### **GameService Changes Required**

#### **1. Split adjudicateAnswer Method**
Current single method needs to be split into two distinct flows:

```typescript
// Current (incorrect)
static async adjudicateAnswer(gameId: string, clueId: string, playerId: string, isCorrect: boolean)

// Required (correct)
static async markPlayerCorrect(gameId: string, clueId: string, playerId: string)
static async markPlayerWrong(gameId: string, clueId: string, playerId: string)
```

#### **2. markPlayerCorrect Implementation**
- Update player score (+clue value)
- Set `focused_clue_id = null` (unfocus clue)
- Set `focused_player_id = null`
- Set `is_buzzer_locked = true`
- Mark clue as completed
- Clear all buzzes for this clue
- **Result**: Clue completed, modal disappears, move to next clue

#### **3. markPlayerWrong Implementation**
- Update player score (-clue value)
- Keep `focused_clue_id = current clue` and don't mark it as completed (clue stays active)
- Set `focused_player_id = null` (clear selection)
- Clear all buzzes for this clue (resetting the buzzer queue for the current clue, creating a new buzz queue)
- Add player ID to `clues.locked_out_player_ids` array (prevent re-buzzing)
- Set `is_buzzer_locked = false` (unlock for remaining players) AND reset timeout
- **Result**: Clue stays active, modal visible, other players can buzz

### **Host Interface Changes Required**

#### **1. Button State Logic**
After "Mark Wrong":
- Button should return to "Lock Buzzer" state (since buzzer is now unlocked)
- Buzzer queue should be empty and ready for new buzzes
- Clue should remain highlighted as "focused"
- Host timeout should be reset for new buzz-in round

#### **2. Multiple Wrong Answers Handling**
- Track which players have already been marked wrong for this clue
- Prevent same player from buzzing again on same clue
- Show visual indicator of players who have already attempted
- If all players have been marked wrong, automatically complete the clue
- Standard completion logic should follow (i.e. `focused_clue_id = null`, `is_buzzer_locked = true`, etc.)

#### **3. Clue Timeout**
- A constant value (e.g., 5 seconds) should be set for the maximum time the buzzer will stay unlocked before the clue is automatically completed (with no players scoring)
- This time limit should be handled on the **host side only** using `setTimeout` for simplicity
- The timeout should reset each time the buzzer is unlocked (initial unlock, or after a wrong answer)
- **Timeout triggers**:
  - Initial buzzer unlock (when host clicks "Unlock Buzzer")
  - After each wrong answer (when buzzer is re-unlocked for remaining players)
  - Can likely be folded into the "unlock" functionality, since every time the buzzer is unlocked, the timeout should also reset
- **Timeout behavior**:
  - Clear any existing timeout before setting new one (`clearTimeout()`)
  - When timeout expires, automatically complete the clue with standard completion logic (`focused_clue_id = null`, `is_buzzer_locked = true`, etc.)
  - Show host notification: "Clue Timeout: <ANSWER>" (display the answer in the alert, so host can read correct answer to players even after the clue is completed)
- **Timeout display**: Host interface should show a countdown timer to indicate remaining time. (Player dashboard should not show the time remaining, per Jeopardy rules)

### **Player Interface Changes Required**

#### **1. Modal Persistence**
- Modal should NOT disappear when player is selected by host
- Modal should disappear for individual players when THEY are marked wrong (via checks against `clues.locked_out_player_ids`)
- Modal should disappear for ALL players when clue is completed (correct answer, buzzer timeout, or all players wrong)

#### **2. Buzzer State Management**
- Players marked wrong have their modal closed (no buzzer state needed)
- Remaining players' buzzers return to "UNLOCKED" state when buzzer is re-enabled
- Prevent already-wrong players from buzzing again by checking `clues.locked_out_player_ids`

## üß™ **Testing Scenarios**

### **Scenario 1: Single Wrong Answer**
1. Host reveals clue, unlocks buzzer. Timeout starts (e.g., 5 seconds)
2. Player A buzzes, host marks wrong
3. **Expected**: Clue stays active, Player A's modal disappears (marked wrong), Player A score updated, Buzzer Queue is cleared, buzzer unlocked on modal for remaining players, buzzer timeout is reset.
4. Player B buzzes, host marks correct
5. **Expected**: Clue completed, Player B's score updated, all modals disappear.

### **Scenario 2: Multiple Wrong Answers**
1. Host reveals clue, unlocks buzzer. Timeout starts (e.g., 5 seconds)
2. Player A buzzes, host marks wrong
3. **Expected**: Clue stays active, Player A's modal disappears (marked wrong), Player A score updated, Buzzer Queue is cleared, buzzer unlocked on modal for remaining players, buzzer timeout is reset.
4. Player B buzzes, host marks wrong
5. **Expected**: Clue stays active, Player B's modal disappears (marked wrong), Player B score updated, Buzzer Queue is cleared, buzzer unlocked on modal for remaining players, buzzer timeout is reset.
6. Player C buzzes, host marks correct
7. **Expected**: Clue completed, Player C's score updated, all modals disappear.

### **Scenario 3: All Players Wrong**
1. Host reveals clue, unlocks buzzer. Timeout starts (e.g., 5 seconds)
2. All players buzz and are marked wrong, as above
3. **Expected**: Clue should be completed (no one left to answer)
4. Host should have option to give correct answer (display the correct answer via an alert, which should remain until the host does something else)

### **Scenario 4: Clue Timeout**
1. Host reveals clue, unlocks buzzer. Timeout starts (e.g., 5 seconds)
2. Player A buzzes, host marks wrong
3. **Expected**: Clue stays active, Player A's modal disappears, buzzer unlocked for remaining players, buzzer timeout is reset.
4. Buzzer timeout elapses.
5. **Expected**: Clue automatically completed, all modals disappear, no score changes, host sees timeout notification with correct answer displayed for reading to players

## üìä **Impact Assessment**

### **Critical Issues Fixed**
- ‚úÖ Proper Jeopardy rule implementation
- ‚úÖ Fair gameplay for all players
- ‚úÖ Correct clue lifecycle management
- ‚úÖ Proper modal state management

### **User Experience Improvements**
- ‚úÖ Players get fair chance to answer after others are wrong
- ‚úÖ Host can properly manage multi-player clue attempts
- ‚úÖ Game flow matches real Jeopardy expectations
- ‚úÖ Clear visual feedback for locked-out players

## üîó **Files Requiring Changes**

### **Backend Services**
- `src/services/games/GameService.ts` - Split adjudication methods
- `src/services/supabase/types.ts` - Update type definitions if needed

### **Host Interface**
- `src/components/games/GameHostDashboard.tsx` - Update button logic and adjudication calls

### **Player Interface**
- `src/components/players/PlayerDashboard.tsx` - Update modal persistence logic and buzzer state management
- `src/components/players/ClueRevealModal.tsx` - Update modal lifecycle

---

*This issue represents a critical bug that prevents proper Jeopardy gameplay. The fix requires careful coordination between host and player interfaces to maintain proper game state throughout the clue lifecycle.*
